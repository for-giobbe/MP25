## Estimate divergence time in a Maximum Likelihood framework

As previusly said ML is a good alternative to the computational burden of BI in the era of phylogenomics and, as almost everything, we can carry on this analyses again with IQ-TREE! It implements the least square dating (LSD2) method to build a time tree when you have date information for tips or ancestral nodes. See ([here](https://academic.oup.com/sysbio/article/65/1/82/2461506) the link for the original paper).

- **Tip dating** is commonly used in two different scenarios:
  - when analyzing viruses
  - hen your have a tree builded up including extinct taxon.

- **Nodes dating** are used when you have informations from 
  - fossils and you want to constrain, usually between two boundaries
  - biogeografical events

---

### Nodes dating

As you may remember we allready inferrred a small Mollusck phylogeny. How can we chose which nodes to calibrates and how to calibrate them? A straightforward way is to just use the same calibration scheme used in previous studies or even the already computed divergence time of certain nodes. In this tutorial we are going for the more straightforward way, taking again the [Kocot et al., 2020](https://www.nature.com/articles/s41598-019-56728-w) pubblication as a reference (the author is one of the major expert in Mollusk phylogeny).

Let'shave a look at some of their divergence time estimations (obtained using Beast and reported in the suppl. informations of the article):

| Node                              | Divergence time (Mya)    | 95% HPD (Mya)     |
| ----------------------------------|:------------------------:| -----------------:|
| Mollusca                          | 545.449                  | 540.386 - 552.405 |
| Monoplacophora                    | 276.956                  | 85.269 - 498.414. |
| Bivalvia + Gastropoda + Scaphopoda| 529.765                  | 525.529 - 534.738 |
| Gastropoda                        | 424.426                  | 408.354 - 439.456 |
| Ganglionata                       | 533.595                  | 527.025 - 540.918 |

Where:
  * **95% HPD** = Confidence interval of the estimation
  * **Ganglionata** = Gastropoda + Scaphopoda + Cephalopoda + Bivalvia
  * **Node** = Start of divergence of the relative clade (crown)

ANSWER:
We can only set 3 calibration points: (1) the divergence between **Bivalvia + Gastropoda + Scaphopoda**, (2) the divergence of **Mollusks**, (3) the divergence of **Gastropoda**. Indeed: 
  
   * **1.** We don't have Monoplacophora samples (not avaible genomes).
   * **2.** In our tree, we don't have the Ganglionata clade (since *A. granulata* fall between cephalopds and Gasteropoda + Mollusca)

So now let's start our dating. First of all, we have to compile a txt files with informations about nodes that we want to constrain (called date file). It should be something like this:

```
taxon1,taxon2 -50
taxon3,taxon4,taxon5 -100
taxon6 -10
```

which, for example, mean that the most recent common ancestor (MRCA) of taxon1 and taxon2 was 50 mya (million year ago) and the MRCA of taxon3, taxon4, taxon5 was 100 mya. Note that **no empty space** should be added to the comma-separated list of taxa, as empty space is used as a separator between taxon list and dates.

After that we need to run IQ-TREE specifing our precomputed ML tree, the partitioning scheme and the date file. Moreover, when dealing with divergence time estimations, it's always better to also specify the outgroup. Indeed time trees, contrary to ML trees, are rooted by definition - they already descibe time!

>If you don't have the date file, you can find mine [here](https://github.com/for-giobbe/phy/blob/master/2021/Data/Ready_to_Use_My_Calibrations.txt)

```bash
iqtree -s Analyses/IQ-TREE/My_Concat.fa --date Data/My_Calibrations.txt -spp Analyses/IQ-TREE/spp_MergedPartitions.best_scheme.nex --date-tip 0 -o "H_robusta" -te Analyses/IQ-TREE/specie.tree.treefile --prefix Analyses/IQ-TREE/Time_Tree/My_DivergenceTime --date-options "-u 1"
```

Results files are almost the same as describe before, beside the presence of a ```timetree.nexus``` file. The nexus format is commonly used in divergence time estimation and Bayesian inference since it is able to store much more information than newick (*e.g* confidence intervals, more variables ...).

Now open the nexus file with figtree and take a look at the tree (remember to display also the node ages)...

..As you can see there is a very short branch between *A.granulata* and other Mollusks. This may be due to 3 variables: (1) **Low taxon sampling**; (2) **Wrong topology** and (3) a true **fast radiation** of Mollusks at the begginning of the Cambrian era. 

IQ-TREE also implements the possibility to calculate CIs of nodes. We can do this while using less calibration points, so we can better understand what our data are telling us (and eventually highlights some conflicts with previously used calibrations). Now, remove all priors except the mollusk one and run:

```bash
iqtree -s Analyses/IQ-TREE/My_Concat.fa --date Data/My_Calibrations_2.txt -spp Analyses/IQ-TREE/spp_MergedPartitions.best_scheme.nex --date-tip 0 -o "H_robusta" -te Analyses/IQ-TREE/specie.tree.treefile --prefix Analyses/IQ-TREE/Time_Tree/My_DivergenceTime_2 --date-options "-u 1" --date-ci 100
```

Taking a look at the resulting tree we can see that the median estimates are not so different from previous results, even if we have some very wide CIs (but it was expected since we have not use any lower or upper boundary).

---

### Tips dating



---

### [main](https://github.com/for-giobbe/MP25/tree/main)